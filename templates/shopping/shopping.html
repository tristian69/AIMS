{% load static %}
{# 이미지 placeholder와 상품 상세 URL fallback을 미리 준비 #}
{% static 'images/placeholder.png' as PRODUCT_PLACEHOLDER %}
<!-- ===================== 쇼핑 모듈 (Partial) ===================== -->
<section id="shopping-module" class="shopping-module">
  <div class="shopping-bar">
    <!-- 브랜드 -->
    <div class="shopping-brand">
      <a href="/" class="shopping-brand__link" aria-label="홈으로 이동">
        <img src="{% static 'images/logo_stand.png' %}" 
            alt="AIMS" 
            class="shopping-brand__logo w-32 h-auto">
      </a>
    </div>

    <!-- 로그인/유저영역 -->
    <ul class="shopping-auth">
      {% if request.user.is_authenticated %}
        <li class="shopping-auth__greeting">
          <span class="greet-text"><strong>{{ request.user.get_full_name|default:"request.user.username" }}</strong> 님</span>
        </li>
        <li><a href="/mypages" class="link">마이페이지</a></li>
        <li>
          <form action="{% url 'users:logout' %}" method="post">
            {% csrf_token %}
            <button type="submit" class="link btn-link">로그아웃</button>
          </form>
        </li>
      {% else %}
        <li><a href="{% url 'users:login' %}" class="link">로그인</a></li>
        <li><a href="{% url 'users:signup' %}" class="link">회원가입</a></li>
      {% endif %}
    </ul>

    <!-- 쇼핑 메뉴 -->
    <ul class="shopping-menu" style="font-family:Nanum Gothic;">
      <!-- 마이페이지 -->
      <li class="shopping-menu__item shopping_my" data-menu-order="my">
        <a class="my_icon" href="/mypages" title="마이페이지">마이</a>
      </li>

      <!-- 장바구니 미니 드롭다운 -->
      <li class="shopping-menu__item shopping_cart" data-menu-order="cart">
        <button id="miniCartToggle"
                class="cart_icon"
                aria-expanded="false"
                aria-controls="miniCartLayer"
                title="장바구니 열기">
          <span id="cartNum" class="cart_num">{{ mini_cart.total_quantity|default:"0" }}</span>
          장바구니
        </button>

        <div id="miniCartLayer" class="mini-cart" hidden>
          <div class="mini-cart__header">
            <strong>장바구니</strong>
            <button class="mini-cart__close" aria-label="장바구니 닫기">&times;</button>
          </div>

          <div class="mini-cart__body">
            {% if mini_cart and mini_cart.items %}
              <ul class="mini-cart__list">
                {% for item in mini_cart.items %}
                  <li class="mini-cart__row" data-line-id="{{ item.id }}">
                    <a class="mini-cart__thumb" href="{{ item.url }}">
                      <img src="{{ item.image_url }}" alt="{{ item.name }}">
                    </a>
                    <div class="mini-cart__meta">
                      <a class="mini-cart__name" href="{{ item.url }}">{{ item.name }}</a>
                      <div class="mini-cart__qtyprice">
                        <span class="qty">수량 {{ item.quantity }}</span>
                        <span class="price">{{ item.line_total|default:"item.price" }}</span>
                      </div>
                    </div>
                    <button class="mini-cart__remove"
                            data-remove-url="/api/cart/remove/"
                            data-product-id="{{ item.product_id }}"
                            aria-label="항목 삭제">삭제</button>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <div class="mini-cart__empty">장바구니가 비어 있습니다.</div>
            {% endif %}
          </div>

          <div class="mini-cart__footer">
            <div class="mini-cart__total">
              <span>합계</span>
              <strong class="total-amount">{{ mini_cart.total_price|default:"₩0" }}</strong>
            </div>
            <div class="mini-cart__actions">
              <a href="/cart" class="btn btn-outline">장바구니 보기</a>
              <a href="/checkout" class="btn btn-primary">주문하기</a>
            </div>
          </div>
        </div>
      </li>

      <!-- 검색 -->
      <li class="shopping-menu__item shopping_search" data-menu-order="search">
        <button type="button" class="btn_search_open" title="상품 검색 열기" aria-expanded="false" aria-controls="shopping-search-layer">
          검색
        </button>

        <div id="shopping-search-layer" class="search_layer" hidden>
          <label class="search_box">
            <input type="text"
                   name="search_input_text"
                   class="search_input_text"
                   autocomplete="off"
                   placeholder="상품 검색"
                   aria-label="상품 검색어 입력" />
          </label>
          <div class="search_actions">
            <button type="button" class="btn_search_header">검색</button>
            <button type="button" class="btn_search_close" aria-label="검색창 닫기">닫기</button>
          </div>
        </div>
      </li>
    </ul>
  </div>

  <!-- ===================== 상품 카드 그리드 ===================== -->
  <div class="product-grid">
    {% if products %}
      <ul class="product-grid__list">
        {% for product in products %}
          <li class="product-card" data-product-id="{{ product.id }}">
            <a class="product-card__thumb" href="{{ product.get_absolute_url|default:"detail_url" }}">
              <img src="{{ product.image_url|default:"PRODUCT_PLACEHOLDER" }}" alt="{{ product.name }}">
            </a>
            <div class="product-card__body">
              <a class="product-card__title"
                 href="{{ product.get_absolute_url|default:"('/products/'|add:product.id|stringformat:'s')" }}">
                {{ product.name }}
              </a>
              <div class="product-card__price">
                {% if product.sale_price %}
                  <span class="sale">{{ product.sale_price }}</span>
                  <del class="retail">{{ product.price }}</del>
                {% else %}
                  <span class="regular">{{ product.price }}</span>
                {% endif %}
              </div>
              <div class="product-card__actions">
                <form class="add-to-cart-form"
                      action="/api/cart/add/"
                      method="post"
                      data-ajax="true">
                  {% csrf_token %}
                  <input type="hidden" name="product_id" value="{{ product.id }}">
                  <input type="hidden" name="quantity" value="1">
                  <button type="submit" class="btn btn-add">담기</button>
                </form>
                <a class="btn btn-outline" href="{{ product.get_absolute_url|default:"('/products/'|add:product.id|stringformat:'s')" }}">자세히</a>
              </div>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="product-grid__empty">
        노출할 상품이 없습니다.
      </div>
    {% endif %}
  </div>
</section>

<!-- ===================== 모듈 전용 스타일 ===================== -->
<style>
  #shopping-module{width:100%;background:#fafafa;border-bottom:1px solid #eee}
  .shopping-bar{max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;gap:16px}
  .shopping-brand{display:flex;align-items:center;margin-right:auto}
  .shopping-brand__logo{height: 48px;display:block}  /* #logo_size_변경 */

  .shopping-auth,.shopping-menu{display:flex;align-items:center;gap:12px;list-style:none;margin:0;padding:0}
  .shopping-auth .link,.btn-link{display:inline-flex;align-items:center;gap:6px;padding:6px 8px;border-radius:6px}
  .shopping-auth .link:hover,.btn-link:hover{text-decoration:underline}

  .shopping-menu__item{position:relative}
  .cart_icon{position:relative;display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid #ddd;border-radius:6px;background:#fff;cursor:pointer}
  .cart_num{min-width:18px;height:18px;line-height:18px;padding:0 5px;font-size:12px;color:#fff;background:#14b8a6;border-radius:9px;text-align:center}

  .search_layer{position:absolute;margin-top:8px;padding:10px;background:#fff;border:1px solid #ddd;border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,.08);display:none;z-index:50}
  .search_box .search_input_text{width:240px;height:36px;padding:0 10px;border:1px solid #ddd;border-radius:6px}
  .search_actions{display:flex;gap:8px;margin-top:8px}
  .btn_search_header,.btn_search_close,.btn_search_open{padding:6px 10px;border:1px solid #ccc;border-radius:6px;background:#f8f8f8;cursor:pointer}

  /* 미니 카트 */
  .mini-cart{position:absolute;top:40px;right:0;width:340px;background:#fff;border:1px solid #ddd;border-radius:10px;box-shadow:0 12px 28px rgba(0,0,0,.12);display:none;z-index:60}
  .mini-cart__header{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #eee}
  .mini-cart__close{border:none;background:transparent;font-size:22px;cursor:pointer;line-height:1}
  .mini-cart__body{max-height:360px;overflow:auto}
  .mini-cart__empty{padding:20px 14px;color:#666}
  .mini-cart__list{list-style:none;margin:0;padding:0}
  .mini-cart__row{display:flex;gap:10px;align-items:center;padding:10px 12px;border-bottom:1px solid #f3f3f3}
  .mini-cart__thumb img{width:56px;height:56px;object-fit:cover;border-radius:6px;border:1px solid #eee}
  .mini-cart__meta{flex:1;min-width:0}
  .mini-cart__name{display:block;font-size:14px;color:#111;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .mini-cart__qtyprice{font-size:12px;color:#666;display:flex;gap:8px;margin-top:4px}
  .mini-cart__remove{border:1px solid #eee;background:#fafafa;border-radius:6px;padding:4px 8px;cursor:pointer}
  .mini-cart__footer{padding:12px;border-top:1px solid #eee}
  .mini-cart__total{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .mini-cart__actions{display:flex;gap:8px}
  .btn{display:inline-flex;align-items:center;justify-content:center;height:36px;padding:0 12px;border-radius:8px;cursor:pointer;text-decoration:none}
  .btn-outline{border:1px solid #ccc;background:#fff}
  .btn-primary{border:1px solid #14b8a6;background:#14b8a6;color:#fff}

  /* 상품 그리드 */
  .product-grid{max-width:1200px;margin:12px auto 24px;padding:0 16px}
  .product-grid__list{list-style:none;margin:0;padding:0;display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
  .product-grid__empty{padding:40px;text-align:center;color:#666;background:#fff;border:1px dashed #ddd;border-radius:12px}
  .product-card{background:#fff;border:1px solid #eee;border-radius:12px;overflow:hidden;display:flex;flex-direction:column}
  .product-card__thumb img{width:100%;aspect-ratio:1/1;object-fit:cover;display:block}
  .product-card__body{padding:12px;display:flex;flex-direction:column;gap:8px}
  .product-card__title{font-size:15px;color:#111;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;min-height:40px}
  .product-card__price{display:flex;gap:8px;align-items:center}
  .product-card__price .sale{color:#ef4444;font-weight:700}
  .product-card__price .retail{color:#999}
  .product-card__actions{display:flex;gap:8px;margin-top:6px}
  .btn-add{border:1px solid #14b8a6;background:#14b8a6;color:#fff}
  .btn-outline{border:1px solid #ccc;background:#fff}

  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,1px,1px);white-space:nowrap;border:0}

  @media (max-width: 1024px){ .product-grid__list{grid-template-columns:repeat(3,1fr)} }
  @media (max-width: 768px){
    .shopping-bar{padding:10px 12px;flex-wrap:wrap;row-gap:8px}
    .product-grid__list{grid-template-columns:repeat(2,1fr)}
    .search_box .search_input_text{width:200px}
  }
</style>

<!-- ===================== 모듈 전용 스크립트 ===================== -->
<script>
  (function () {
    // ============ 검색 레이어 ============
    const openBtn  = document.querySelector('#shopping-module .btn_search_open');
    const layer    = document.querySelector('#shopping-search-layer');
    const input    = document.querySelector('#shopping-search-layer .search_input_text');
    const doBtn    = document.querySelector('#shopping-search-layer .btn_search_header');
    const closeBtn = document.querySelector('#shopping-search-layer .btn_search_close');

    if (openBtn && layer) {
      const show = () => { layer.style.display='block'; layer.hidden=false; openBtn.setAttribute('aria-expanded','true'); setTimeout(()=>input&&input.focus(),0); };
      const hide = () => { layer.style.display='none';  layer.hidden=true;  openBtn.setAttribute('aria-expanded','false'); openBtn.focus(); };

      openBtn.addEventListener('click', (e)=>{ e.preventDefault(); (openBtn.getAttribute('aria-expanded')==='true') ? hide() : show(); });
      closeBtn && closeBtn.addEventListener('click', hide);
      doBtn && doBtn.addEventListener('click', ()=>{ const q=(input&&input.value||'').trim(); if(!q){ input&&input.focus(); return; } window.location.href = `/search?q=${encodeURIComponent(q)}`; });
      document.addEventListener('keydown', (e)=>{ if (e.key==='Escape' && !layer.hidden) hide(); });
      document.addEventListener('click', (e)=>{ if (layer.hidden) return; if (!layer.contains(e.target) && !openBtn.contains(e.target)) hide(); });
    }

    // ============ 미니 카트 ============
    const miniBtn   = document.getElementById('miniCartToggle');
    const miniLayer = document.getElementById('miniCartLayer');
    const miniClose = miniLayer ? miniLayer.querySelector('.mini-cart__close') : null;

    function miniShow(){ if(!miniLayer) return; miniLayer.style.display='block'; miniLayer.hidden=false; miniBtn && miniBtn.setAttribute('aria-expanded','true'); }
    function miniHide(){ if(!miniLayer) return; miniLayer.style.display='none';  miniLayer.hidden=true;  miniBtn && miniBtn.setAttribute('aria-expanded','false'); }

    miniBtn && miniBtn.addEventListener('click', (e)=>{ e.preventDefault(); (miniBtn.getAttribute('aria-expanded')==='true') ? miniHide() : miniShow(); });
    miniClose && miniClose.addEventListener('click', miniHide);
    document.addEventListener('keydown', (e)=>{ if (e.key==='Escape' && miniLayer && !miniLayer.hidden) miniHide(); });
    document.addEventListener('click', (e)=>{ if (!miniLayer || miniLayer.hidden) return; if (!miniLayer.contains(e.target) && !miniBtn.contains(e.target)) miniHide(); });

    // ============ CSRF ============
    function getCookie(name) {
      const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)'); return m ? m.pop() : '';
    }
    const CSRF = getCookie('csrftoken');

    // ============ Add to Cart (AJAX) ============
    document.querySelectorAll('.add-to-cart-form[data-ajax="true"]').forEach(form=>{
      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const fd = new FormData(form);
        try {
          const res = await fetch(form.action || '/api/cart/add/', {
            method: 'POST',
            headers: { 'X-CSRFToken': CSRF },
            body: fd
          });
          if (!res.ok) throw new Error('장바구니 담기에 실패했습니다.');
          const data = await res.json().catch(()=> ({}));
          // 기대 응답: { ok: true, total_quantity: n, mini_cart_html?: "..."}
          const totalQty = data.total_quantity ?? null;
          if (typeof totalQty === 'number') {
            const badge = document.getElementById('cartNum'); if (badge) badge.textContent = totalQty;
          }
          // 서버가 미니카트 HTML을 반환하면 갱신
          if (data.mini_cart_html && miniLayer) {
            miniLayer.innerHTML = data.mini_cart_html;
          }
          miniShow();
        } catch(err) {
          alert(err.message || '일시적인 오류가 발생했습니다.');
        }
      });
    });

    // ============ Mini Cart 항목 삭제 ============
    miniLayer && miniLayer.addEventListener('click', async (e)=>{
      const btn = e.target.closest('.mini-cart__remove');
      if (!btn) return;
      e.preventDefault();
      const productId = btn.getAttribute('data-product-id');
      const removeUrl = btn.getAttribute('data-remove-url') || '/api/cart/remove/';
      if (!productId) return;

      try {
        const res = await fetch(removeUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF },
          body: JSON.stringify({ product_id: productId })
        });
        if (!res.ok) throw new Error('삭제에 실패했습니다.');
        const data = await res.json().catch(()=> ({}));
        // 기대 응답: { ok: true, total_quantity: n, mini_cart_html?: "..."}
        if (data.mini_cart_html) {
          miniLayer.innerHTML = data.mini_cart_html;
        } else {
          // fallback: DOM에서 해당 line 제거
          const row = btn.closest('.mini-cart__row'); row && row.remove();
        }
        if (typeof data.total_quantity === 'number') {
          const badge = document.getElementById('cartNum'); if (badge) badge.textContent = data.total_quantity;
        }
      } catch (err) {
        alert(err.message || '일시적인 오류가 발생했습니다.');
      }
    });
  })();
</script>
